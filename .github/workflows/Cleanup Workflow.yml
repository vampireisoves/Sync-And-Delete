name: Cleanup Workflow

on:
  schedule:
    - cron: '0 * * * *' # 每个整点（UTC）自动运行
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI and jq
        run: sudo apt-get update && sudo apt-get install gh jq -y

      - name: Delete old workflow runs for all workflows
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          for WF_ID in $(gh api repos/${{ github.repository }}/actions/workflows | jq -r '.workflows[].id'); do
            PAGE=1
            ALL_RUNS_JSON="[]"
            while :; do
              RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/$WF_ID/runs?per_page=100&page=$PAGE)
              RUN_COUNT=$(echo "$RUNS" | jq '.workflow_runs | length')
              [ "$RUN_COUNT" -eq 0 ] && break
              ALL_RUNS_JSON=$(jq -s 'add' <(echo "$ALL_RUNS_JSON") <(echo "$RUNS" | jq '.workflow_runs'))
              ((PAGE++))
            done
            # 按创建时间逆序排列，只保留最新5个，其余全部删除
            OLD_RUN_IDS=$(echo "$ALL_RUNS_JSON" | jq -r 'sort_by(.created_at) | reverse | .[5:] | .[].id')
            for ID in $OLD_RUN_IDS; do
              gh api --method DELETE repos/${{ github.repository }}/actions/runs/$ID
              echo "Deleted run $ID of workflow $WF_ID"
            done
          done
