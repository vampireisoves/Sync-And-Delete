name: Cleanup Workflow

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI and jq
        run: sudo apt-get install gh jq -y

      - name: Delete old workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for WF_ID in $(gh api repos/${{ github.repository }}/actions/workflows | jq -r '.workflows[].id'); do
            RUN_IDS=$(gh api repos/${{ github.repository }}/actions/workflows/$WF_ID/runs?per_page=100 | jq -r '.workflow_runs | sort_by(.created_at) | reverse | .[5:] | .[].id')
            for ID in $RUN_IDS; do
              gh api --method DELETE repos/${{ github.repository }}/actions/runs/$ID
              echo "Deleted run $ID of workflow $WF_ID"
            done
          done
